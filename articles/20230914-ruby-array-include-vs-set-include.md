---
title: "ã€Rubyã€‘Array#include?ã‚’é«˜é€ŸåŒ–ã™ã‚‹æ–¹æ³•"
emoji: "ğŸ’"
type: "tech" # tech: æŠ€è¡“è¨˜äº‹ / idea: ã‚¢ã‚¤ãƒ‡ã‚¢
topics: ["ruby"]
published: true
published_at: 2023-09-14 08:00
---
## çµè«–
ãƒ¬ã‚·ãƒ¼ãƒã¨ãªã‚‹è¦ç´ ã‚’`to_set`ãƒ¡ã‚½ãƒƒãƒ‰ã§`Set`ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã«å¤‰æ›ã—ã€`include?`ã‚’ä½¿ã†ã¨é«˜é€Ÿã«åˆ¤å®šã§ãã¾ã™ã€‚

`Array#include?`ã¯æ¤œç´¢ã‚¢ãƒ«ã‚´ãƒªã‚ºãƒ ã®ç·šå½¢æ¢ç´¢(O(n))ã‚’è¡Œã†ãŸã‚ã€ãƒ‡ãƒ¼ã‚¿é‡(=è¦ç´ æ•°)ãŒå¤šããªã‚‹ã»ã©å‡¦ç†æ™‚é–“ãŒå¢—åŠ ã—ã¾ã™ã€‚ä¸€æ–¹ã€`Set#include?`ã¯å†…éƒ¨çš„ã«ãƒãƒƒã‚·ãƒ¥ã‚’ä½¿ç”¨ã—ã¦ã„ã‚‹ãŸã‚ã€å‡¦ç†æ™‚é–“ã¯ãƒ‡ãƒ¼ã‚¿é‡(=è¦ç´ æ•°)ã«å½±éŸ¿ã•ã‚Œãšå¸¸ã«ä¸€å®š(O(1))ã§ã™ã€‚

```ruby
array = [1, 2, 3, 4, 5]
set = array.to_set

array.include?(4) # O(n)
set.include?(4) # O(1) â€»ã“ã¡ã‚‰ã®ã»ã†ãŒé«˜é€Ÿ
```

| ãƒ¡ã‚½ãƒƒãƒ‰ | è¨ˆç®—é‡(Oè¨˜æ³•) | ç‰¹å¾´ |
| ------ | ------------ | ---- |
| `Array#include?` | O(n) | ãƒ»æ¤œç´¢ã‚¢ãƒ«ã‚´ãƒªã‚ºãƒ ã®ç·šå‹æ¢ç´¢ã«ã‚ãŸã‚‹ <br>ãƒ»ãƒ‡ãƒ¼ã‚¿é‡ãŒå¤šããªã‚‹ã»ã©å‡¦ç†ã«æ™‚é–“ãŒã‹ã‹ã‚‹ |
| `Set#include?` | O(1) | ãƒ»æ¤œç´¢ã‚¢ãƒ«ã‚´ãƒªã‚ºãƒ ã®ãƒãƒƒã‚·ãƒ¥æ³•ã«ã‚ãŸã‚‹ <br> ãƒ»å‡¦ç†æ™‚é–“ã¯ãƒ‡ãƒ¼ã‚¿é‡ã«é–¢ä¿‚ãªãä¸€å®š |

## å‡¦ç†ã®æ·±å €ã‚Š
### Array#include?
**é…åˆ—ã®å…ˆé ­ã‹ã‚‰é †ç•ªã«å¼•æ•°ã®å€¤ã¨æ¯”è¼ƒ**ã—ã€ä¸€è‡´ã™ã‚‹è¦ç´ ã‚’è¦‹ã¤ã‘ãŸæ™‚ç‚¹ã§trueã‚’è¿”ã—ã¾ã™ã€‚

```ruby
array = [1, 2, 3, 4, 5]
array.include?(4) # 1â†’2â†’3â†’4 ã¨å…ˆé ­ã‹ã‚‰é †ç•ªã«ç¢ºèªã—ã€4ã‚’è¦‹ã¤ã‘ãŸæ™‚ç‚¹ã§ true
```

:::details Array#include?ã®å†…éƒ¨å®Ÿè£…
https://github.com/ruby/ruby/blob/a98209b8a70345714ac5f3028e0591f3ee50bba7/array.c#L5212-L5225

å†…éƒ¨å®Ÿè£…ã‚’è¦‹ã¦ã¿ã‚‹ã¨ã€é…åˆ—ã®å…ˆé ­ã‹ã‚‰é †ç•ªã«æ¯”è¼ƒã—ã¦ã„ã‚‹ã“ã¨ãŒã‚ã‹ã‚Šã¾ã™ã€‚ãã®ãŸã‚ã€å¯¾è±¡ã®è¦ç´ ãŒå…ˆé ­ã‹ã‚‰é ã‘ã‚Œã°é ã„ã»ã©ã€ä¸€è‡´ã™ã‚‹ã¾ã§ã«æ™‚é–“ãŒã‹ã‹ã‚Šã¾ã™ã€‚

ã¾ãŸã€å¯¾è±¡ã®è¦ç´ ãŒé…åˆ—å†…ã«å­˜åœ¨ã—ã¦ã„ãªã„å ´åˆã¯ã€é€”ä¸­ã§ä¸€è‡´ã™ã‚‹ã“ã¨ãŒãªã„ã®ã§ã€é…åˆ—ã®å…ˆé ­ã‹ã‚‰æœ«å°¾ã¾ã§ã‚’å…¨ã¦æ¯”è¼ƒã™ã‚‹ã“ã¨ã«ãªã‚Šã¾ã™ã€‚
:::

### Set#include?
`Set`ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã¯å†…éƒ¨çš„ã«ãƒãƒƒã‚·ãƒ¥ã‚’ä¿æŒã—ã¦ãŠã‚Šã€è¦ç´ ã®å­˜åœ¨ç¢ºèªãŒé«˜é€Ÿã§ã™ã€‚

```ruby
set = [1, 2, 3, 4, 5].to_set
# setã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã¯å†…éƒ¨çš„ã«æ¬¡ã®ã‚ˆã†ãªãƒãƒƒã‚·ãƒ¥ã‚’ä¿æŒã™ã‚‹ã€‚ï¼ˆãƒ‡ãƒ•ã‚©ãƒ«ãƒˆå€¤: falseï¼‰
# @hash = { 1 => true, 2 => true, 3 => true, 4 => true, 5 => true }

set.include?(4) # ç›´æ¥ @hash[4] ã‚’å‚ç…§ã™ã‚‹ã®ã§é«˜é€Ÿ
```

:::details to_setã®å†…éƒ¨å®Ÿè£…
### â‘ Enumerable#to_set
https://github.com/ruby/ruby/blob/4655d2108ef14e66f64496f9029f65ba2302d9ea/prelude.rb#L28-L30
`to_set`ã‚’å‘¼ã³å‡ºã™ã¨ã€ã¾ãšã¯`Set.new`ã§`Set`ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã‚’ç”Ÿæˆã—ã¾ã™ã€‚

### â‘¡Set#initialize
https://github.com/ruby/ruby/blob/a98209b8a70345714ac5f3028e0591f3ee50bba7/lib/set.rb#L243-L253
ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆãŒç”Ÿæˆã•ã‚Œã‚‹ã¨ã‚³ãƒ³ã‚¹ãƒˆãƒ©ã‚¯ã‚¿ãŒå‘¼ã³å‡ºã•ã‚Œã¾ã™ã€‚

ã“ã“ã§ã€`@hash(ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆå€¤: false)`ã‚’ç”Ÿæˆã—ã¦ã„ã¾ã™ã€‚ãã—ã¦`block`ã¯æ¸¡ã—ã¦ã„ãªã„ã®ã§ã€`merge(enum)`ãŒå®Ÿè¡Œã•ã‚Œã¾ã™ã€‚

### â‘¢Set#merge
https://github.com/ruby/ruby/blob/a98209b8a70345714ac5f3028e0591f3ee50bba7/lib/set.rb#L603-L613
å¼•æ•°ã§æ¸¡ã•ã‚ŒãŸ`enum`ã‚’å¯å¤‰é•·å¼•æ•°ã¨ã—ã¦å—ã‘å–ã‚Šã¾ã™ã€‚`enum`ã¯`to_set`å‘¼ã³å‡ºã—æ™‚ã®ãƒ¬ã‚·ãƒ¼ãƒã®è¦ç´ (ex. `[1, 2, 3, 4, 5]`)ãªã®ã§ã€å¯å¤‰é•·å¼•æ•°ã¨ã—ã¦å—ã‘å–ã‚‹ã“ã¨ã§`[[1, 2, 3, 4, 5]]`ã®ã‚ˆã†ãª2æ¬¡å…ƒé…åˆ—ã«ãªã‚Šã¾ã™ã€‚

ãã®ãŸã‚ã€`do_with_enum(enum) { |o| add(o) }`å´ã®å‡¦ç†ãŒå®Ÿè¡Œã•ã‚Œã¾ã™ã€‚

### â‘£Set#do_with_enum
https://github.com/ruby/ruby/blob/a98209b8a70345714ac5f3028e0591f3ee50bba7/lib/set.rb#L272-L281

å¼•æ•°ã®`enum`ã¯`[1, 2, 3, 4, 5]`ãªã®ã§é…åˆ—ã§ã™ã€‚é…åˆ—ã¯`each_entry`ãƒ¡ã‚½ãƒƒãƒ‰ã‚’ä¿æŒã—ã¦ã„ã‚‹ã®ã§`enum.each_entry(&block) if block`ãŒå®Ÿè¡Œã•ã‚Œã¾ã™ã€‚

`each_entry`ãƒ¡ã‚½ãƒƒãƒ‰ã¯ã€å„è¦ç´ ã«ãƒ–ãƒ­ãƒƒã‚¯ã®å‡¦ç†ã‚’ä¸€åº¦ãšã¤é©ç”¨ã™ã‚‹ãƒ¡ã‚½ãƒƒãƒ‰ã§ã™ã€‚ãã®ãŸã‚`[1, 2, 3, 4, 5]`ã®å„è¦ç´ ã«å¯¾ã—ã¦å¼•æ•°ã§æ¸¡ã•ã‚ŒãŸãƒ–ãƒ­ãƒƒã‚¯ã®å‡¦ç†(=`{ |o| add(o) }`)ãŒå®Ÿè¡Œã•ã‚Œã¾ã™ã€‚

#### â‘¤Set#add
https://github.com/ruby/ruby/blob/a98209b8a70345714ac5f3028e0591f3ee50bba7/lib/set.rb#L519-L522
å¼•æ•°ã®`o`ã¯ã€`[1, 2, 3, 4, 5]`ã®å„è¦ç´ ã§ã€å„è¦ç´ ã‚’`@hash`ã®ã‚­ãƒ¼ã¨ã—ã¦æ ¼ç´ã—ã¾ã™ã€‚

ãã®ãŸã‚ã€`[1, 2, 3, 4, 5].to_set`ã‚’è¡Œã†ã¨å†…éƒ¨çš„ã«ä»¥ä¸‹ã®ã‚ˆã†ãªãƒãƒƒã‚·ãƒ¥ãŒç”Ÿæˆã•ã‚Œã¦ä¿æŒã•ã‚Œã¾ã™ã€‚
```ruby
@hash = { 1 => true, 2 => true, 3 => true, 4 => true, 5 => true }
```
:::

:::details Set#include?ã®å†…éƒ¨å®Ÿè£…
https://github.com/ruby/ruby/blob/a98209b8a70345714ac5f3028e0591f3ee50bba7/lib/set.rb#L401-L403
`Set`ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆç”Ÿæˆæ™‚ã«ã€å†…éƒ¨çš„ã«ç”Ÿæˆã—ãŸ`@hash`ã«å¯¾ã—ã¦ã‚­ãƒ¼å‚ç…§ãŒè¡Œã‚ã‚Œã€O(1)ã§çµæœã‚’å–å¾—ã§ãã¾ã™ã€‚
:::

## å‡¦ç†é€Ÿåº¦ã®æ¤œè¨¼
`Array#include?`ã¨`Set#include?`ã®å‡¦ç†é€Ÿåº¦ã‚’æ¯”è¼ƒã—ã¦ã€ã©ã‚Œãã‚‰ã„å·®ãŒã‚ã‚‹ã®ã‹ã‚’ç¢ºèªã—ã¦ã¿ã¾ã™ã€‚

### æ¤œè¨¼ç”¨ã‚³ãƒ¼ãƒ‰
```ruby
def benchmark_include(length)
  array = (1..length).to_a
  set = array.to_set

  Benchmark.bm do |x|
    x.report('Array:') { array.include?(length) }
    x.report('Set:') { set.include?(length) }
  end
end

[100, 100_0, 100_00, 100_000, 100_000_0].each do |length|
  pp "length: #{length}"
  benchmark_include(length)
end
```

### æ¤œè¨¼çµæœ
```ruby
"length: 100"
       user     system      total        real
Array:  0.000017   0.000000   0.000017 (  0.000003)
Set:  0.000003   0.000000   0.000003 (  0.000002)
"length: 1000"
       user     system      total        real
Array:  0.000006   0.000000   0.000006 (  0.000005)
Set:  0.000002   0.000000   0.000002 (  0.000002)
"length: 10000"
       user     system      total        real
Array:  0.000023   0.000012   0.000035 (  0.000035)
Set:  0.000002   0.000001   0.000003 (  0.000001)
"length: 100000"
       user     system      total        real
Array:  0.000232   0.000113   0.000345 (  0.000345)
Set:  0.000002   0.000001   0.000003 (  0.000002)
"length: 1000000"
       user     system      total        real
Array:  0.003023   0.000001   0.003024 (  0.003023)
Set:  0.000004   0.000001   0.000005 (  0.000003)
```
è¦ç´ æ•°ãŒå¢—ãˆã‚‹ã«ã¤ã‚Œã€`Array#include?`ã®å‡¦ç†æ™‚é–“ã¯æ¯”ä¾‹ã—ã¦å¢—åŠ ã—ã¾ã™ãŒã€`Set#include?`ã¯å¸¸ã«ä¸€å®šã®æ™‚é–“ã§çµæœã‚’è¿”ã—ã¦ã„ã¾ã™ã€‚

## å‚è€ƒè¨˜äº‹
https://qiita.com/an_sony/items/708c47d073ad709431d6
https://nekomaho.hatenablog.jp/entry/2019/05/28/083000
