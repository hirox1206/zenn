---
title: "ã€Rubyã€‘Array#include?ã¯to_setã§é€Ÿããªã‚‹"
emoji: "ğŸ’"
type: "tech" # tech: æŠ€è¡“è¨˜äº‹ / idea: ã‚¢ã‚¤ãƒ‡ã‚¢
topics: ["ruby"]
published: true
published_at: 2023-09-14 08:00
---

## ã¯ã˜ã‚ã«

é…åˆ—ã«ç‰¹å®šã®è¦ç´ ãŒå«ã¾ã‚Œã¦ã„ã‚‹ã‹ã‚’åˆ¤å®šã—ãŸã„ã¨ãã€ã‚ˆã`Array#include?`ã‚’åˆ©ç”¨ã™ã‚‹ã¨æ€ã„ã¾ã™ãŒã€ãã®éš›ã«ä¸€å·¥å¤«ï¼ˆ`to_set`ï¼‰ã—ã¦ã‚ã’ã‚‹ã ã‘ã§ã€ã‚ˆã‚Šé€Ÿãåˆ¤å®šã™ã‚‹ã“ã¨ãŒã§ãã¾ã™ã€‚

## é€Ÿããªã‚‹ç†ç”±

`Array#include?`ã¯æ¤œç´¢ã‚¢ãƒ«ã‚´ãƒªã‚ºãƒ ã®ç·šå‹æ¢ç´¢ã«ã‚ãŸã‚Šã€ãƒ‡ãƒ¼ã‚¿é‡(=è¦ç´ æ•°)ãŒå¤šããªã‚‹ã»ã©å‡¦ç†ã«æ™‚é–“ãŒã‹ã‹ã‚Šã¾ã™ã€‚
ä¸€æ–¹ã§`Set#include?`ã¯æ¤œç´¢ã‚¢ãƒ«ã‚´ãƒªã‚ºãƒ ã®ãƒãƒƒã‚·ãƒ¥æ³•ã«ã‚ãŸã‚Šã€å‡¦ç†æ™‚é–“ã¯ãƒ‡ãƒ¼ã‚¿é‡(=è¦ç´ æ•°)ã«é–¢ä¿‚ãªãä¸€å®šã«ãªã‚‹ã®ã§ã€to_set ã—ãŸæ–¹ãŒé«˜é€Ÿã«åˆ¤å®šã™ã‚‹ã“ã¨ãŒã§ãã‚‹ã®ã§ã™ã€‚

### Array#include?

é…åˆ—ã®å…ˆé ­ã‹ã‚‰é †ç•ªã«ã€å¼•æ•°ã§æ¸¡ã•ã‚ŒãŸå€¤ã¨ç­‰ã—ã„ã‹ã‚’ãƒã‚§ãƒƒã‚¯ã—ã¦ã„ãã€ç­‰ã—ã‘ã‚Œã° true ã‚’è¿”ã—ã¾ã™ã€‚

```ruby
[1, 2, 3, 4, 5]
# ã“ã®ã‚ˆã†ãªé…åˆ—ã‹ã‚‰4ãŒå«ã¾ã‚Œã¦ã‚‹ã‹ã‚’åˆ¤å®šã—ãŸã„æ™‚
# ãƒ»å…ˆé ­ã®1ã‚’è¦‹ã‚‹ã€‚
# ãƒ»1ã¯4ã§ã¯ãªã„ã®ã§ã€æ¬¡ã®è¦ç´ 2ã‚’è¦‹ã‚‹ã€‚
# ãƒ»2ã¯4ã§ã¯ãªã„ã®ã§ã€æ¬¡ã®è¦ç´ 3ã‚’è¦‹ã‚‹ã€‚
# ãƒ»ï¼šä»¥é™åŒã˜åˆ¤å®šã‚’ç¹°ã‚Šè¿”ã—å®Ÿæ–½ã—ã¦ã„ãã€4ã‚’è¦‹ã¤ã‘æ¬¡ç¬¬ true ã‚’è¿”ã™ã€‚
# ãƒ»â€»é…åˆ—ã®è¦ç´ å…¨ã¦ã‚’ç¢ºèªã—ã¦ã‚‚è¦‹ã¤ã‘ã‚‰ã‚Œãªã‹ã£ãŸå ´åˆã¯ false ã‚’è¿”ã™ã€‚
```

:::details Array#include?ã®å®Ÿè£…ã‚’è©³ã—ãè¦‹ã¦ã¿ã‚‹
https://github.com/ruby/ruby/blob/a98209b8a70345714ac5f3028e0591f3ee50bba7/array.c#L5212-L5225

C è¨€èªã§æ›¸ã‹ã‚ŒãŸå®Ÿè£…ã‚’è¦‹ã¦ã¿ã‚‹ã¨ã€é…åˆ—ã®å…ˆé ­ã‹ã‚‰é †ç•ªã«åˆ¤å®šã—ã¦ã„ã‚‹ã“ã¨ãŒã‚ã‹ã‚Šã¾ã™ã­ã€‚
åˆ¤å®šã™ã‚‹è¦ç´ ãŒå…ˆé ­ã‹ã‚‰é›¢ã‚ŒãŸä½ç½®ã«ã‚ã‚Œã°ã‚ã‚‹ã»ã©ã€ä¸€è‡´ã™ã‚‹ã¾ã§ã«æ™‚é–“ãŒã‹ã‹ã‚‹ã“ã¨ãŒæƒ³åƒã§ãã¾ã™ã€‚
:::

### Set#include?

é…åˆ—ã‚’æ¸¡ã—ã¦ Set ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã‚’ç”Ÿæˆã—ãŸæ™‚ã€ã“ã® Set ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã¯`{ è¦ç´  => true, ... }`ã®ã‚ˆã†ãªãƒãƒƒã‚·ãƒ¥ã‚’å†…éƒ¨çš„ã«ä¿æŒã—ã¾ã™ã€‚

```ruby
set = [1, 2, 3, 4, 5].to_set
# ã“ã®ã¨ãsetã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã¯ä»¥ä¸‹ã®ã‚ˆã†ãªãƒãƒƒã‚·ãƒ¥ã‚’ä¿æŒã™ã‚‹ã€‚
@hash = { 1 => true, 2 => true, 3 => true, 4 => true, 5 => true }
```

:::details to_set ã—ãŸæ™‚ã®å®Ÿè£…ã‚’è©³ã—ãè¦‹ã¦ã¿ã‚‹
ã€å‰æã€‘`[1, 2, 3].to_set`ã‚’å®Ÿè¡Œã—ãŸçŠ¶æ³ã‚’å…ƒã«è¦‹ã¦ã„ãã¾ã™ã€‚

### â‘ Enumerable#to_set

https://github.com/ruby/ruby/blob/4655d2108ef14e66f64496f9029f65ba2302d9ea/prelude.rb#L28-L30

å˜ç´”ã«`Set.new([1, 2, 3])`ã—ã¦ã„ã‚‹ã ã‘ã§ã™ã­ã€‚
new ã¯ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã‚’ç”Ÿæˆã™ã‚‹ãƒ¡ã‚½ãƒƒãƒ‰ãªã®ã§ã€Set ã‚¯ãƒ©ã‚¹ã®ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆãŒç”Ÿæˆã•ã‚Œã¾ã™ã€‚

### ã€€ â‘¡Set#initialize

https://github.com/ruby/ruby/blob/a98209b8a70345714ac5f3028e0591f3ee50bba7/lib/set.rb#L243-L253

ã“ã“ã§æ³¨ç›®ã—ã¦ã»ã—ã„ã®ãŒã€`@hash ||= Hash.new(false)`ã®éƒ¨åˆ†ã§ã™ã€‚
ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆå€¤ãŒ false ã®ãƒãƒƒã‚·ãƒ¥ã‚’ç”Ÿæˆã—ã¦ã€ã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹å¤‰æ•°ã®`@hash`ã«ä¿æŒã—ã¦ã„ã¾ã™ã€‚
ãã—ã¦ block ã¯æ¸¡ã—ã¦ã„ãªã„ã®ã§ã€merge ãŒå®Ÿè¡Œã•ã‚Œã¾ã™ã€‚
initialize ã«ã¯ new ã«ä¸ãˆãŸå¼•æ•°ãŒãã®ã¾ã¾æ¸¡ã•ã‚Œã‚‹ã®ã§ã€enum ã«ã¯`[1, 2, 3]`ãŒæ ¼ç´ã•ã‚Œã¦ã¾ã™ã€‚
ãã®ãŸã‚ merge ã®å¼•æ•°ã¨ã—ã¦`[1, 2, 3]`ãŒæ¸¡ã•ã‚Œã¾ã™ã€‚

### â‘¢Set#merge

https://github.com/ruby/ruby/blob/a98209b8a70345714ac5f3028e0591f3ee50bba7/lib/set.rb#L603-L613

å¯å¤‰é•·å¼•æ•°ã¨ã—ã¦å—ã‘å–ã£ã¦ã„ã‚‹ã®ã§ enums ã¯ `[[1, 2, 3]]` ã¨ã„ã†çŠ¶æ…‹ã«ãªã‚Šã¾ã™ã€‚
`enum`ã¯é…åˆ—ã«ãªã‚Š`do_with_enum(enum) { |o| add(o) }`ãŒå®Ÿè¡Œã•ã‚Œã¾ã™ã€‚

### â‘£Set#do_with_enum

https://github.com/ruby/ruby/blob/a98209b8a70345714ac5f3028e0591f3ee50bba7/lib/set.rb#L272-L281

Array ã¯ each_entry ã‚’æŒã£ã¦ã„ã‚‹ã®ã§`enum.each_entry(&block) if block`ãŒå®Ÿè¡Œã•ã‚Œã¾ã™ã€‚
each_entry ã¯ã€æ¸¡ã•ã‚ŒãŸãƒ–ãƒ­ãƒƒã‚¯ã‚’å„è¦ç´ ã«ä¸€åº¦ãšã¤é©ç”¨ã™ã‚‹ã®ã§ã€`[1, 2, 3]`ã®å„è¦ç´ ã«å¯¾ã—ã¦ add ãŒå®Ÿè¡Œã•ã‚Œã‚‹ã“ã¨ã«ãªã‚Šã¾ã™ã€‚

#### â‘¤Set#add

https://github.com/ruby/ruby/blob/a98209b8a70345714ac5f3028e0591f3ee50bba7/lib/set.rb#L519-L522

ã“ã“ã§å„è¦ç´ ã‚’`@hash`ã®ã‚­ãƒ¼ã¨ã—ã¦ã‚»ãƒƒãƒˆã—ã¦ã„ã¾ã™ã€‚
ãªã®ã§ã€`[1, 2, 3].to_set`ã‚’è¡Œã†ã¨å†…éƒ¨çš„ã«ä»¥ä¸‹ã®ã‚ˆã†ãªãƒãƒƒã‚·ãƒ¥ã¨ã—ã¦ä¿æŒã•ã‚Œã‚‹ã®ã§ã™ã€‚

```ruby
@hash = { 1 => true, 2 => true, 3 => true }
```

:::

`Set#include?`ã§ã¯ã€ã“ã®ãƒãƒƒã‚·ãƒ¥ã‚’å‚ç…§ã™ã‚‹ã“ã¨ã§ã€å­˜åœ¨ã—ã¦ã„ã‚‹æ™‚ã¯ true ãŒè¿”ã‚Šã€å­˜åœ¨ã—ãªã„æ™‚ã¯ false ãŒè¿”ã‚Šã¾ã™ã€‚

```ruby
set = [1, 2, 3, 4, 5].to_set
set.include?(4)
# ã“ã®ã¨ãsetã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã«å†…éƒ¨çš„ã«ä¿æŒã•ã‚Œã¦ã„ã‚‹ä»¥ä¸‹ã®ãƒãƒƒã‚·ãƒ¥ã«å¯¾ã—ã¦ @hash[4] ã§å‚ç…§ã™ã‚‹ã€‚
# ãƒ»å‚ç…§ã—ãŸçµæœ true ãŒè¿”ã‚‹
@hash = { 1 => true, 2 => true, 3 => true, 4 => true, 5 => true }

set.include?(6)
# ã“ã®ã¨ãsetã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã«å†…éƒ¨çš„ã«ä¿æŒã•ã‚Œã¦ã„ã‚‹ä»¥ä¸‹ã®ãƒãƒƒã‚·ãƒ¥ã«å¯¾ã—ã¦ @hash[6] ã§å‚ç…§ã™ã‚‹ã€‚
# ãƒ»å‚ç…§ã—ãŸçµæœå­˜åœ¨ã—ãªã„ã®ã§falseãŒè¿”ã‚‹
# ãƒ»â€» nil ã§ã¯ãªã false ãŒè¿”ã•ã‚Œã‚‹ã®ã¯ã€ä»¥ä¸‹ãƒãƒƒã‚·ãƒ¥ã®ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆå€¤ã¨ã—ã¦ false ãŒè¨­å®šã•ã‚Œã¦ã„ã‚‹ãŸã‚ã§ã™ã€‚
@hash = { 1 => true, 2 => true, 3 => true, 4 => true, 5 => true }
```

:::details Set#include?ã®å®Ÿè£…ã‚’è©³ã—ãè¦‹ã¦ã¿ã‚‹
https://github.com/ruby/ruby/blob/a98209b8a70345714ac5f3028e0591f3ee50bba7/lib/set.rb#L401-L403

è¦‹ã¦ã®é€šã‚Šã€Set ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆç”Ÿæˆæ™‚ã«å†…éƒ¨çš„ã«ä¿æŒã—ãŸãƒãƒƒã‚·ãƒ¥ã«å¯¾ã—ã¦ã€å¼•æ•°ã§æŒ‡å®šã•ã‚ŒãŸä½ç½®ã‚’å‚ç…§ã—ã¦ã„ã‚‹ã ã‘ã§ã™ã€‚
:::

ã“ã®ã‚ˆã†ã«ã€ãƒ‡ãƒ¼ã‚¿é‡(=è¦ç´ æ•°)ãŒã©ã‚Œã ã‘å¢—ãˆã¦ã‚‚ã€å¸¸ã«æŒ‡å®šã•ã‚ŒãŸä½ç½®ã«ã‚¢ã‚¯ã‚»ã‚¹ã—ã«è¡Œãã®ã§ã€é«˜é€Ÿã§åˆ¤å®šã™ã‚‹ã“ã¨ãŒã§ãã‚‹ã®ã§ã™ã€‚

## å®Ÿéš›ã«æ¤œè¨¼ã—ã¦ã¿ã‚‹

`Array#include?`ã‚’åˆ©ç”¨ã—ãŸæ™‚ã¨`Set#include?`ã‚’åˆ©ç”¨ã—ãŸæ™‚ã®å‡¦ç†é€Ÿåº¦ã‚’æ¯”è¼ƒã—ã¦ã€ã©ã‚Œãã‚‰ã„ã®å·®ãŒã‚ã‚‹ã®ã‹ã‚’ç¢ºèªã—ã¦ã¿ã¾ã™ã€‚

```ruby:æ¤œè¨¼ç”¨ã‚³ãƒ¼ãƒ‰
def benchmark_include(length)
  array = (1..length).to_a
  set = array.to_set

  Benchmark.bm do |x|
    x.report('Array:') { array.include?(length) }
    x.report('Set:') { set.include?(length) }
  end
end

[100, 100_0, 100_00, 100_000, 100_000_0].each do |length|
  pp "length: #{length}"
  benchmark_include(length)
end
```

ã“ã‚Œã‚’å®Ÿè¡Œã™ã‚‹ã¨ã“ã®ã‚ˆã†ãªçµæœã«ãªã‚Šã¾ã™ã€‚

```ruby:çµæœ
"length: 100"
       user     system      total        real
Array:  0.000017   0.000000   0.000017 (  0.000003)
Set:  0.000003   0.000000   0.000003 (  0.000002)
"length: 1000"
       user     system      total        real
Array:  0.000006   0.000000   0.000006 (  0.000005)
Set:  0.000002   0.000000   0.000002 (  0.000002)
"length: 10000"
       user     system      total        real
Array:  0.000023   0.000012   0.000035 (  0.000035)
Set:  0.000002   0.000001   0.000003 (  0.000001)
"length: 100000"
       user     system      total        real
Array:  0.000232   0.000113   0.000345 (  0.000345)
Set:  0.000002   0.000001   0.000003 (  0.000002)
"length: 1000000"
       user     system      total        real
Array:  0.003023   0.000001   0.003024 (  0.003023)
Set:  0.000004   0.000001   0.000005 (  0.000003)
```

`Array#include?`ã§ã¯è¦ç´ æ•°ãŒå¢—ãˆã¦ã„ãã”ã¨ã«å‡¦ç†ã«æ™‚é–“ãŒã‹ã‹ã£ã¦ã„ã¾ã™ãŒã€`Set#include?`ã§ã¯è¦ç´ æ•°ãŒå¢—ãˆã¦ã‚‚å‡¦ç†é€Ÿåº¦ãŒå¤‰ã‚ã£ã¦ã„ãªã„ã“ã¨ãŒã‚ã‹ã‚Šã¾ã™ã­ã€‚

## ã¾ã¨ã‚

| ãƒ¡ã‚½ãƒƒãƒ‰       | è¨ˆç®—é‡(O è¨˜æ³•) | ç‰¹å¾´                                                                                |
| -------------- | -------------- | ----------------------------------------------------------------------------------- |
| Array#include? | O(n)           | ãƒ»æ¤œç´¢ã‚¢ãƒ«ã‚´ãƒªã‚ºãƒ ã®ç·šå‹æ¢ç´¢ã«ã‚ãŸã‚‹ <br>ãƒ»ãƒ‡ãƒ¼ã‚¿é‡ãŒå¤šããªã‚‹ã»ã©å‡¦ç†ã«æ™‚é–“ãŒã‹ã‹ã‚‹ |
| Set#include?   | O(1)           | ãƒ»æ¤œç´¢ã‚¢ãƒ«ã‚´ãƒªã‚ºãƒ ã®ãƒãƒƒã‚·ãƒ¥æ³•ã«ã‚ãŸã‚‹ <br> ãƒ»å‡¦ç†æ™‚é–“ã¯ãƒ‡ãƒ¼ã‚¿é‡ã«é–¢ä¿‚ãªãä¸€å®š      |

## å‚è€ƒã«ã•ã›ã¦ã„ãŸã ã„ãŸè¨˜äº‹

https://qiita.com/an_sony/items/708c47d073ad709431d6
https://nekomaho.hatenablog.jp/entry/2019/05/28/083000
